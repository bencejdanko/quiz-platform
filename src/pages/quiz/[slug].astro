---
import { getQuizBySlug } from '../../lib/loader';
import Authors from '../../components/Authors.astro';
import UserAuth from '../../components/UserAuth.astro';

export const prerender = false;

const { slug } = Astro.params;
const quiz = await getQuizBySlug(slug!);

if (!quiz) {
    return Astro.redirect('/404');
}
---


<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<title>{quiz.title} | Quiz Platform</title>
		<style is:global>
			:root {
				--bg: #010409;
				--fg: #ffffff;
				--accent: #ffffff;
				--card-bg: #010409;
				--card-border: #ffffff;
				--success: #238636;
				--error: #da3633;
			}
			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
				background-color: var(--bg);
				color: var(--fg);
				margin: 0;
				padding: 2rem;
				display: flex;
				flex-direction: column;
				align-items: center;
			}
			.container {
				max-width: 800px;
				width: 100%;
			}
			header {
				margin-bottom: 2rem;
				text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
			}
			header a {
				color: #58a6ff;
				text-decoration: none;
				font-size: 0.9rem;
				display: inline-block;
				margin-bottom: 1rem;
			}
			header a:hover {
				text-decoration: underline;
			}
			h1 {
				margin: 0;
				font-size: 2rem;
				font-weight: 600;
			}
            .authors-container {
                margin-top: 1rem;
            }
			.question-card {
				background: var(--card-bg);
				border: 1px solid var(--card-border);
				padding: 1.5rem;
				border-radius: 6px;
				margin-bottom: 1.5rem;
			}
			.question-text {
				font-size: 1.1rem;
				font-weight: 600;
				margin-bottom: 1.25rem;
			}
			.options {
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}
			.option-label {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				padding: 0.75rem;
				border: 1px solid #30363d;
				border-radius: 6px;
				cursor: pointer;
			}
			.option-label:hover {
				background: #0d1117;
				border-color: #8b949e;
			}
			.option-label.selected {
				border-color: #58a6ff;
				background: #0d1117;
			}
			input[type="checkbox"], input[type="radio"] {
				width: 1rem;
				height: 1rem;
				accent-color: #58a6ff;
			}
			.submit-btn {
				background: #238636;
				color: #ffffff;
				border: 1px solid rgba(240, 246, 252, 0.1);
				padding: 0.75rem 1.5rem;
				font-size: 1rem;
				font-weight: 600;
				border-radius: 6px;
				cursor: pointer;
				width: 100%;
			}
			.submit-btn:hover {
				background: #2ea043;
			}
			.submit-btn:disabled {
				background: #216e39;
				cursor: not-allowed;
				opacity: 0.6;
			}
			#result {
				margin-bottom: 2rem;
				padding: 1.5rem;
				border-radius: 6px;
				text-align: center;
				display: none;
			}
			#result.visible {
				display: block;
			}
			.success { border: 1px solid var(--success); background: #010409; color: #3fb950; }
			.error { border: 1px solid var(--error); background: #010409; color: #f85149; }
			
			.question-card.correct { border-color: var(--success); }
			.question-card.incorrect { border-color: var(--error); }

			.option-label.correct {
				background: rgba(35, 134, 54, 0.15) !important;
				border-color: var(--success) !important;
			}
			.option-label.incorrect {
				background: rgba(218, 54, 51, 0.15) !important;
				border-color: var(--error) !important;
			}
			.option-label.missed {
				border-style: dashed;
				border-color: var(--success);
				background: transparent;
			}
			
			.text-input {
				width: 100%;
				box-sizing: border-box;
				padding: 0.75rem;
				background: #0d1117;
				border: 1px solid #30363d;
				border-radius: 6px;
				color: var(--fg);
				font-size: 1rem;
				font-family: inherit;
			}
			.text-input:focus {
				outline: none;
				border-color: #58a6ff;
				box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
			}
			.text-input.correct {
				border-color: var(--success);
			}
			.text-input.incorrect {
				border-color: var(--error);
			}

			.correct-answer-reveal {
				margin-top: 1rem;
				padding: 0.75rem;
				background: rgba(35, 134, 54, 0.1);
				border-left: 4px solid var(--success);
				border-radius: 4px;
				font-size: 0.9rem;
			}
			
			.status-badge {
				display: inline-block;
				padding: 2px 8px;
				border-radius: 2em;
				font-size: 0.75rem;
				font-weight: 600;
				margin-bottom: 0.5rem;
				text-transform: uppercase;
				border: 1px solid currentColor;
			}
			.status-badge.correct { color: #3fb950; }
			.status-badge.incorrect { color: #f85149; }
			
			.community-hint {
				margin-top: 1rem;
				font-size: 0.85rem;
				color: #8b949e;
				display: flex;
				align-items: center;
				gap: 4px;
				font-style: italic;
			}

			.explanation {
				margin-top: 1rem;
				padding: 0.75rem;
				background: rgba(88, 166, 255, 0.1);
				border-left: 4px solid #58a6ff;
				border-radius: 4px;
				font-size: 0.9rem;
				color: #c9d1d9;
				line-height: 1.5;
			}

			input:disabled {
				cursor: not-allowed;
			}
		</style>

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css">
	</head>
	<body>
        <UserAuth />
		<div class="container">
			<header>
				<a href="/">‚Üê Back to Hub</a>
				<h1>{quiz.title}</h1>
                <div class="authors-container">
                    <Authors authors={quiz.authors} />
                </div>
			</header>

			<div id="result"></div>
			<form id="quiz-form">
				{quiz.questions.map((question, qIndex) => (
					<div class="question-card" data-question-id={question.id} data-type={question.type}>
						<div class="question-text" set:html={question.text}></div>
						<div class="answer-area">
							{question.type === 'choice' ? (
								<div class="options">
									{question.options.map((option, oIndex) => {
										const isMulti = question.options.filter(o => o.isCorrect).length > 1;
										return (
											<label class="option-label">
												<input 
													type={isMulti ? "checkbox" : "radio"} 
													name={question.id} 
													value={oIndex} 
												/>
												<span set:html={option.text}></span>
											</label>
										);
									})}
								</div>
							) : (
								<div class="text-input-wrapper">
									<input 
										type="text" 
										name={question.id} 
										class="text-input" 
										placeholder="Type your answer here..."
										autocomplete="off"
									/>
								</div>
							)}
						</div>
					</div>
				))}
				<button type="submit" class="submit-btn" id="submit-btn">Submit Answers</button>
			</form>

		</div>

		<script define:vars={{ quizSlug: quiz.slug, quizData: quiz }}>
			const form = document.getElementById('quiz-form');
			const resultDiv = document.getElementById('result');

			// Add visual feedback for selection
			form.addEventListener('change', (e) => {
				const label = e.target.closest('label');
				const name = e.target.name;
				const type = e.target.type;

				if (type === 'radio') {
					// Clear other selections in the same group
					form.querySelectorAll(`input[name="${name}"]`).forEach(input => {
						input.closest('label').classList.remove('selected');
					});
				}
				
				if (e.target.checked) {
					label.classList.add('selected');
				} else {
					label.classList.remove('selected');
				}
			});

			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				
				const submitBtn = document.getElementById('submit-btn');
				submitBtn.disabled = true;
				submitBtn.innerText = 'Submitting...';

				const formData = new FormData(form);
				const answers = [];

				quizData.questions.forEach(question => {
					if (question.type === 'choice') {
						const selectedIndices = formData.getAll(question.id).map(v => parseInt(v));
						if (selectedIndices.length > 0) {
							answers.push({ questionId: question.id, selectedIndices });
						}
					} else {
						const textAnswer = formData.get(question.id);
						if (textAnswer) {
							answers.push({ questionId: question.id, textAnswer });
						}
					}
				});

				const payload = {
					quizSlug: quizSlug,
					answers
				};

				try {
					const response = await fetch('/api/submit', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});

					if (!response.ok) {
						const errorData = await response.json().catch(() => ({}));
						throw new Error(errorData.error || `Server returned ${response.status}`);
					}

					const data = await response.json();
					
					// Update UI with results
					data.results = data.results || {};
					const stats = data.stats || {};

					quizData.questions.forEach((question) => {
						const isCorrect = data.results[question.id];
						const card = form.querySelector(`[data-question-id="${question.id}"]`);
						
						// Add status badge
						const badge = document.createElement('div');
						badge.className = `status-badge ${isCorrect ? 'correct' : 'incorrect'}`;
						badge.innerText = isCorrect ? 'Correct' : 'Incorrect';
						card.prepend(badge);
						card.classList.add(isCorrect ? 'correct' : 'incorrect');

						// Add community hint
						if (stats[question.id]) {
							const hintDiv = document.createElement('div');
							hintDiv.className = 'community-hint';
							const rate = Math.round(stats[question.id].correctRate * 100);
							hintDiv.innerHTML = `<svg viewBox="0 0 16 16" width="12" height="12" fill="currentColor" style="vertical-align: middle; margin-right: 4px;"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25z"></path></svg>${rate}% of submissions got this correct`;
							card.appendChild(hintDiv);
						}

						if (question.type === 'choice') {
							const userSelections = formData.getAll(question.id).map(v => parseInt(v));
							question.options.forEach((option, idx) => {
								const label = card.querySelectorAll('.option-label')[idx];
								const isUserSelected = userSelections.includes(idx);
								const isActuallyCorrect = option.isCorrect;

								if (isUserSelected && isActuallyCorrect) {
									label.classList.add('correct');
								} else if (isUserSelected && !isActuallyCorrect) {
									label.classList.add('incorrect');
								} else if (!isUserSelected && isActuallyCorrect) {
									label.classList.add('missed');
								}
							});
						} else {
							const input = card.querySelector('.text-input');
							input.classList.add(isCorrect ? 'correct' : 'incorrect');
							if (!isCorrect) {
								const correctDiv = document.createElement('div');
								correctDiv.className = 'correct-answer-reveal';
								const correctAnswers = question.options.map(o => o.text).join(' or ');
								correctDiv.innerHTML = `Correct answer: <strong>${correctAnswers}</strong>`;
								card.appendChild(correctDiv);
							}
						}

						// Add explanation if available
						if (question.explanation) {
							const explanationDiv = document.createElement('div');
							explanationDiv.className = 'explanation';
							explanationDiv.innerHTML = `<strong>Note:</strong> ${question.explanation}`;
							card.appendChild(explanationDiv);
						}
					});

					// Disable all inputs
					form.querySelectorAll('input').forEach(input => input.disabled = true);
					submitBtn.style.display = 'none';

					resultDiv.innerHTML = `
						<h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Quiz Complete!</h2>
						<p style="font-size: 1.25rem; margin-bottom: 1.5rem;">Your Score: <span style="color: #58a6ff; font-weight: 600;">${data.score} / ${data.total}</span></p>
						<div style="display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center;">
							<a href="/" style="color: #c9d1d9; text-decoration: none; padding: 0.5rem 1rem; border: 1px solid #30363d; border-radius: 6px; font-size: 0.9rem;">Hub</a>
							<a href="/submissions/${quizSlug}" style="background: #238636; color: white; text-decoration: none; padding: 0.5rem 1rem; border: 1px solid rgba(240, 246, 252, 0.1); border-radius: 6px; font-size: 0.9rem; font-weight: 600;">View Public Results</a>
							<button onclick="window.location.reload()" style="background: #21262d; border: 1px solid #30363d; color: #c9d1d9; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Try Again</button>
						</div>
					`;
					resultDiv.className = 'visible success';
					window.scrollTo({ top: 0, behavior: 'smooth' });
				} catch (err) {
					console.error(err);
					alert(`Submission failed: ${err.message}`);
					submitBtn.disabled = false;
					submitBtn.innerText = 'Submit Answers';
				}
			});
		</script>
	</body>
</html>
